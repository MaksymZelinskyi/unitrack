<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>New Collaborator</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body class="body-bg">
<div th:insert="fragments :: header"></div>

<div class="new-collab-container">
    <!-- LEFT SIDE -->
    <div class="new-collab-left">
        <h1 class="page-title">New Collaborator</h1>

        <form th:action="@{/collaborators/new}" th:object="${collaboratorForm}" id="collaboratorForm"
              method="post" class="collab-form">

            <div class="form-group">
                <label>First Name</label>
                <input th:field="*{firstName}" id="firstName" type="text" placeholder="John" required>
            </div>

            <div class="form-group">
                <label>Last Name</label>
                <input th:field="*{lastName}" id="lastName" type="text" placeholder="Doe" required>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input th:field="*{email}" id="email" type="email" placeholder="johndoe@email.com" required>
                <span id="error" class="error-msg">Invalid email address</span>
            </div>

            <div class="form-group">
                <label>Password</label>
                <input th:field="*{password}" id="password" type="password" placeholder="••••••••" minlength="8">
            </div>

            <div class="form-group">
                <label>Assign Projects</label>
                <select id="projectPicker">
                    <option value="" disabled selected>Select a project</option>
                    <option th:each="project : ${projects}" th:value="${project.id}" th:text="${project.title}"></option>
                </select>
            </div>

            <button type="submit" class="submit-btn">Create Collaborator</button>
        </form>
    </div>

    <!-- RIGHT SIDE -->
    <div class="new-collab-right">
        <h2 class="section-title">Selected Projects</h2>
        <div id="selected-list" class="selected-list">
            <p id="no-projects" class="placeholder">No projects selected yet.</p>
        </div>
    </div>
</div>

<script>
    (function () {
      const picker = document.getElementById('projectPicker');
      const list = document.getElementById('selected-list');
      const placeholder = document.getElementById('no-projects');

      picker.addEventListener('change', function () {
        const id = this.value;
        if (!id) return;
        const name = this.options[this.selectedIndex].text;
        placeholder?.remove();

        if (list.querySelector(`[data-id="${CSS.escape(id)}"]`)) {
          this.value = '';
          return;
        }

        const row = document.createElement('div');
        row.className = 'project-row';
        row.dataset.id = id;
        row.innerHTML = `
          <button type="button" class="remove-btn" title="Remove">×</button>
          <span class="project-name">${name}</span>
          <input type="hidden" name="selected[0].id" value="${id}">
          <select name="selected[0].role" class="role-select">
            <option value="BACKEND_DEV" selected>Backend Dev</option>
            <option value="FRONTEND_DEV">Frontend Dev</option>
            <option value="FULLSTACK_DEV">Fullstack Dev</option>
            <option value="TESTER">Tester</option>
            <option value="DEVOPS">DevOps</option>
            <option value="DESIGNER">Designer</option>
            <option value="PRODUCT_OWNER">Product Owner</option>
            <option value="INTERN">Intern</option>
          </select>
        `;
        list.appendChild(row);
        reindex();
        this.value = '';
      });

      list.addEventListener('click', function (e) {
        if (e.target.closest('.remove-btn')) {
          const row = e.target.closest('.project-row');
          row?.remove();
          reindex();
          if (!list.children.length) {
            list.innerHTML = '<p id="no-projects" class="placeholder">No projects selected yet.</p>';
          }
        }
      });

      function reindex() {
        list.querySelectorAll('.project-row').forEach((row, i) => {
          const idInput = row.querySelector('input[type="hidden"]');
          const roleSel = row.querySelector('select');
          if (idInput) idInput.name = `selected[${i}].id`;
          if (roleSel) roleSel.name = `selected[${i}].role`;
        });
      }
    })();
</script>

<script>
    const form = document.getElementById('collaboratorForm');
    const emailInput = document.getElementById('email');
    const errorSpan = document.getElementById('error');

    form.addEventListener('submit', (event) => {
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(emailInput.value)) {
        event.preventDefault();
        errorSpan.style.display = 'inline';
      } else {
        errorSpan.style.display = 'none';
      }
    });
</script>
</body>
</html>