<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Uni-Track</title>
    <link rel="stylesheet" href="/styles/main.css"/>
</head>
<body>
    <div th:insert="fragments :: header"></div>
    <div class="layout">
        <!-- Card -->
        <div class="card">

            <!-- Comments Counter (top-right) -->
            <div class="absolute top-5 right-5 bg-blue-50 border border-blue-200 rounded-xl px-5 py-3 flex flex-col items-center gap-2 shadow-sm hover:shadow-md transition-all duration-300">
                <div class="flex items-baseline gap-1 text-blue-700 font-semibold">
                    <h6 th:text="${comments.size()}" class="text-3xl leading-none"></h6>
                    <p th:text="${'comment' + (comments.size() == 1 ? '' : 's')}" class="text-gray-600 text-sm font-medium">comments</p>
                </div>
                <a href="#comments"
                   class="goto">
                    Go to comments ‚Üí
                </a>
            </div>

            <!-- Title -->
            <h1 class="section-title" th:text="${task.title}"></h1>

            <!-- Description -->
            <div class="desc">
                <span class="label">Description:</span>
                <p th:text="${task.description}"></p>
            </div>

            <!-- Deadline -->
            <div class="flex justify-between items-center border-b py-4">
                <span class="date-label">Deadline:</span>
                <span class="date" th:text="${#temporals.format(task.deadline, 'dd MMM yyyy HH:mm')}"></span>
            </div>

            <!-- Assignees -->
            <div class="section">
                <label class="section-title">Assignees</label>

                <!-- Scrollable list -->
                <aside class="sidebar">
                    <ul class="collab-list">
                        <li th:if="${task.assignees == null || #lists.isEmpty(task.assignees)}"
                            class="desc">Nobody assigned</li>

                        <li th:each="assignee : ${task.assignees}">
                            <img alt="Profile Picture"
                                 class="avatar"
                                 th:src="${assignee.avatarUrl}"/>

                            <div class="flex-col">
                                <span class="desc" th:text="${assignee.name}"></span>
                                <span class="desc" th:text="${assignee.role}"></span>
                            </div>
                        </li>
                    </ul>
                </aside>
            </div>

            <!-- Action Buttons -->
            <div>
                <!-- Delete -->
                <form method="post"
                      th:action="@{/tasks/{id}(id=${task.id})}"
                      th:if="${canDelete}">
                    <input name="_method" type="hidden" value="delete">
                    <button
                            class="remove-btn">
                        <img alt="Delete" class="w-5 h-5"
                             src="https://www.pngmart.com/files/17/Waste-Garbage-Can-Vector-PNG-Clipart.png"/>
                        <span class="font-medium">Delete</span>
                    </button>
                </form>

                <!-- Modify -->
                <form method="get"
                      th:action="@{/tasks/update/{id}(id=${task.id})}"
                      th:if="${canUpdate}">
                    <button
                            class="task-edit-btn">
                        <img alt="Modify" class="w-5 h-5"
                             src="https://www.pngmart.com/files/23/Pens-PNG-Isolated-File.png"/>
                        <span class="font-medium">Modify</span>
                    </button>
                </form>

                <!-- Complete Toggle -->
                <form method="post"
                      th:action="@{/tasks/complete/{id}(id=${task.id})}"
                      th:if="${canUpdate}">
                    <label class="toggle-label">
                        <span>Mark as completed</span>
                        <div class="toggle-wrapper">
                            <input
                                    aria-label="Mark as completed"
                                    class="toggle-input"
                                    id="completed"
                                    name="completed"
                                    onclick="this.form.submit()"
                                    th:checked="${task.status == 'DONE'}"
                                    type="checkbox">
                            <div class="toggle-bg"></div>
                            <div class="toggle-ball"
                                 th:classappend="${task.status == 'DONE'} ? 'translate-x-6 bg-green-500' : ''"></div>
                        </div>
                    </label>
                </form>
            </div>
        </div>
    </div>
    <!-- üí¨ Comments Section -->
    <div>

        <!-- üìù Add Comment Form -->
        <form th:action="@{/tasks/comments?taskId={taskId}(taskId=${task.id})}" method="post" th:object="${commentForm}"
              class="comment-form">

            <div>
                <label class="label">Add a Comment</label>
                <input th:field="*{text}" type="text"
                       placeholder="Write something thoughtful..."
                       maxlength="255"
                       required
                       class="input"/>
            </div>

            <button type="submit"
                    class="submit-btn">
                Post
            </button>
        </form>

        <!-- üí¨ Comments List -->
        <ul id="comments" class="comment-list">
            <!-- No comments message -->
            <li th:if="${comments == null || #lists.isEmpty(comments)}"
                class="desc">
                No comments yet ‚Äî be the first to share your thoughts!
            </li>

            <!-- Each Comment -->
            <li th:each="comment : ${comments}">
                 <div th:id="'comment' + ${comment.id}" class="comment-card">
                    <!-- üßë‚Äçüíª Author Header -->
                    <div>
                        <a th:href="@{/collaborators/{id}(id=${comment.author.id})}">
                            <img alt="Profile Picture"
                                 class="avatar"
                                 th:src="${comment.author.avatarUrl}"/>

                            <div>
                                <h3 class="collab-name"
                                    th:text="${comment.author.name}">
                                    Author Name
                                </h3>
                                <p class="italic"
                                   th:text="${#temporals.format(comment.createdAt, 'dd MMM yyyy HH:mm')}">
                                    Date
                                </p>
                            </div>
                        </a>

                        <a th:if="${comment.replyTo != null}" th:href="'#comment'+${comment.replyTo}"
                           class="desc"
                           th:text="'Replied to ' + ${comment.replyToAuthor}" >
                        </a>
                        <!-- Edit Button -->
                        <button type="button"
                                class="comment-edit-btn"
                                th:if="${comment.author.id == currentUser.id}">
                            ‚úèÔ∏è Edit
                        </button>
                    </div>

                    <!-- üó®Ô∏è Comment Text -->
                    <p class="desc"
                       th:text="${comment.text}">
                        Comment content here...
                    </p>

                    <!-- ‚úèÔ∏è Edit Form (hidden by default) -->
                    <form method="post" th:if="${comment.author.id == currentUser.id}"
                          th:action="@{/tasks/comments/{id}(id=${comment.id})}">
                        <input type="hidden" name="_method" value="put"/>

                        <textarea name="text"
                                  class="desc"
                                  th:text="${comment.text}"></textarea>

                        <div>
                            <button type="submit"
                                    class="submit-btn">
                                üíæ Save
                            </button>
                            <button type="button"
                                    class="cancel-btn">
                                ‚úñ Cancel
                            </button>
                        </div>
                    </form>

                    <!-- üóëÔ∏è Delete Button -->
                    <form method="post"
                          th:action="@{/tasks/comments/{id}(id=${comment.id})}"
                          th:if="${comment.author.id == currentUser.id || currentUser.status == 'Admin'}">
                        <input name="_method" type="hidden" value="delete">
                        <button type="submit"
                                class="delete-btn">
                            <img alt="Delete" style="height: 1.25rem; width: 1.25rem"
                                 src="https://www.pngmart.com/files/17/Waste-Garbage-Can-Vector-PNG-Clipart.png"/>
                            <span class="font-medium">Delete</span>
                        </button>
                    </form>
                     <button type="button"
                                   class="submit-btn">
                     Ô∏è üó®Ô∏è Reply
                     </button>
                </div>

                <!-- ‚úèÔ∏è Comment reply Form (hidden by default) -->
                <form method="post"
                      th:action="@{/tasks/comments?taskId={taskId}(taskId=${task.id})}"
                >

                    <input type="hidden" name="replyTo" th:value="${comment.id}"/>

                    <input type="text" name="text"
                              class="input"
                    />

                    <div>
                        <button type="submit"
                                class="submit-btn">
                            üíæ Save
                        </button>
                        <button type="button"
                                class="cancel-btn">
                            ‚úñ Cancel
                        </button>
                    </div>
                </form>
            </li>
        </ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script th:inline="javascript">
        let task = [[${task}]];
    </script>
    <script>
        const sections = document.querySelectorAll(".sortable");

        sections.forEach(section => {
          new Sortable(section, {
            group: "shared", //allows moving between lists
            animation: 150,
            onAdd: async function (evt) {
              let taskId = evt.item.dataset.id;
              let newSection = evt.to.id;

              //Send PUT request
              await fetch(`/tasks/${taskId}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newStatus: newSection })
              });
              window.location.reload();
            }
          });
        });
    </script>

    <!-- ‚ú® Edit/Cancel Logic -->
    <script>
        document.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                const comment = editBtn.closest('li');
                comment.querySelector('.comment-text').classList.add('hidden');
                comment.querySelector('.comment-edit-form').classList.remove('hidden');
            }

            const cancelBtn = e.target.closest('.cancel-btn');
            if (cancelBtn) {
                const comment = cancelBtn.closest('li');
                comment.querySelector('.comment-text').classList.remove('hidden');
                comment.querySelector('.comment-edit-form').classList.add('hidden');
            }
        });
    </script>
    <script>
        document.addEventListener('click', (e) => {
            const replyBtn = e.target.closest('.reply-btn');
            if (replyBtn) {
                const comment = replyBtn.closest('li');
                comment.querySelector('.comment-reply-form').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>