<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Uni-Track</title>
    <th:block th:insert="fragments :: head"></th:block>
</head>
<body>

<div th:insert="fragments :: header"></div>

<div class="page-container">

    <div class="content-split">

        <!-- Left: Task -->
        <div class="task-view">

            <div class="task-topbar">
                <div class="comment-counter">
                    <span th:text="${comments.size()}">0</span>
                    <small th:text="${'comment' + (comments.size() == 1 ? '' : 's')}">comments</small>
                </div>
                <a href="#comments" class="link-faded">Go to comments â†’</a>
            </div>

            <h1 class="task-title" th:text="${task.title}"></h1>

            <section class="detail-block">
                <label>Description</label>
                <p th:text="${task.description}"></p>
            </section>

            <section class="detail-block">
                <label>Deadline</label>
                <span th:text="${#temporals.format(task.deadline, 'dd MMM yyyy HH:mm')}"></span>
            </section>

            <div class="task-buttons bottom">

                <form method="post" th:action="@{/tasks/{id}(id=${task.id})}" th:if="${canDelete}">
                    <input type="hidden" name="_method" value="delete"/>
                    <button class="btn danger confirm-delete">Delete</button>
                </form>

                <form method="get" th:action="@{/tasks/update/{id}(id=${task.id})}" th:if="${canUpdate}">
                    <button class="btn primary">Modify</button>
                </form>
                <form method="post" th:action="@{/tasks/complete/{id}(id=${task.id})}" th:if="${canUpdate}" class="right">
                    <label class="toggle-label" for="completed">
                         <span>Mark as completed</span>

                        <div class="toggle-wrapper">
                            <input
                                    aria-label="Mark as completed"
                                    id="completed"
                                    name="completed"
                                    onclick="this.form.submit()"
                                    th:checked="${task.status == 'DONE'}"
                                    type="checkbox"
                                    class="toggle-input"
                            >

                            <div class="toggle-bg"></div>
                            <div class="toggle-ball"
                                 th:classappend="${task.status == 'DONE'} ? ' toggled' : ''">
                            </div>
                        </div>
                    </label>
                </form>
            </div>

        </div>

        <!-- Right: Sidebar -->
        <aside class="task-sidebar">
            <label class="sidebar-title">Assignees</label>
            <ul class="assignees-list">

                <li class="empty-text"
                    th:if="${task.assignees == null || #lists.isEmpty(task.assignees)}">Nobody assigned
                </li>

                <li th:each="assignee : ${task.assignees}">
                    <a class="assignee-row" th:href="@{/collaborators/{id}(id=${assignee.id})}">
                        <img class="avatar" th:src="${#strings.isEmpty(assignee.avatarUrl) ? '/icons/profile-icon.png' : assignee.avatarUrl}">
                        <div>
                            <p class="assignee-name" th:text="${assignee.name}"></p>
                            <p class="assignee-role" th:text="${assignee.role}"></p>
                        </div>
                    </a>
                </li>
            </ul>
        </aside>

    </div>
</div>

<!-- Comments Section -->
<section class="comments-section" id="comments">

    <form class="comment-form" method="post"
          th:action="@{/tasks/comments?taskId={taskId}(taskId=${task.id})}"
          th:object="${commentForm}">
        <input class="input comment-input" th:field="*{text}" placeholder="Write a commentâ€¦" maxlength="255" required>
        <button class="btn submit" type="submit">Post</button>
    </form>

    <ul class="comment-list">

        <li class="empty-text" th:if="${comments == null || #lists.isEmpty(comments)}">
            No comments yet â€” be the first!
        </li>

        <li th:each="comment : ${comments}">
            <div class="comment-card">

                <div class="comment-header">
                    <a class="author-link" th:href="@{/collaborators/{id}(id=${comment.author.id})}">
                        <img class="avatar small"
                             th:src="${#strings.isEmpty(comment.author.avatarUrl) ? '/icons/profile-icon.png' : comment.author.avatarUrl}"
                        >
                        <div>
                            <p class="author-name" th:text="${comment.author.name}"></p>
                            <small th:text="${#temporals.format(comment.createdAt, 'dd MMM yyyy HH:mm')}"></small>
                        </div>
                    </a>

                    <a class="reply-ref"
                       th:href="'#comment'+${comment.replyTo}"
                       th:if="${comment.replyTo != null}"
                       th:text="'Replied to ' + ${comment.replyToAuthor}"></a>

                    <button class="btn edit-btn"
                            th:if="${comment.author.id == currentUser.id}"
                            type="button">Edit</button>
                </div>

                <p class="comment-text" th:text="${comment.text}"></p>

                    <!-- Edit Form -->
                    <form class="comment-edit-form hidden"
                          method="post"
                          th:action="@{/tasks/comments/{id}(id=${comment.id})}"
                          th:if="${comment.author.id == currentUser.id}">
                        <input name="_method" type="hidden" value="put">
                        <textarea class="input" name="text" th:text="${comment.text}"></textarea>
                        <div>
                            <button class="submit-btn" type="submit">Save</button>
                            <button class="cancel-btn" type="button">Cancel</button>
                        </div>
                    </form>

                    <div class="flex-row">
                        <!-- Delete -->
                        <form method="post"
                              th:action="@{/tasks/comments/{id}(id=${comment.id})}"
                              th:if="${comment.author.id == currentUser.id || currentUser.status == 'Admin'}">
                            <input name="_method" type="hidden" value="delete">
                            <button class="delete-btn" type="submit">
                                <span>Delete</span>
                            </button>
                        </form>

                        <!-- Reply -->
                        <button class="reply-btn" type="button">ðŸ’¬ Reply</button>
                    </div>
            </div>

            <!-- Reply form -->
            <form class="comment-reply-form hidden"
                  method="post"
                  th:action="@{/tasks/comments?taskId={taskId}(taskId=${task.id})}">
                <input name="replyTo" th:value="${comment.id}" type="hidden"/>
                <input class="input" name="text" type="text"/>
                <div>
                    <button class="submit-btn" type="submit">Save</button>
                    <button class="cancel-btn" type="button">Cancel</button>
                </div>
            </form>
        </li>

    </ul>
</section>

<div th:insert="fragments :: confirm-modal"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="/js/comments.js"></script>
<script src="/js/confirmation.js"></script>
</body>
</html>
