<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Uni-Track</title>
    <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
    />
</head>
<body>
<div th:insert="fragments :: header"></div>
<div class="flex flex-col items-center justify-center py-10 bg-gray-50 min-h-screen">

    <!-- Card -->
    <div class="w-5/6 max-w-3xl bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-8 relative">

        <!-- Title -->
        <h1 class="text-3xl font-bold text-blue-700 mb-6 border-b pb-3" th:text="${task.title}"></h1>

        <!-- Description -->
        <div class="flex justify-between items-start border-b py-4">
            <span class="text-gray-600 font-semibold">Description:</span>
            <p class="text-gray-800 text-right max-w-sm" th:text="${task.description}"></p>
        </div>

        <!-- Deadline -->
        <div class="flex justify-between items-center border-b py-4">
            <span class="text-gray-600 font-semibold">Deadline:</span>
            <span class="text-gray-800" th:text="${task.deadline}"></span>
        </div>

        <!-- Assignees -->
        <div class="py-6">
            <label class="block text-lg font-semibold text-gray-700 mb-4">Assignees</label>

            <!-- Scrollable list -->
            <div class="max-h-48 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-blue-500 scrollbar-track-gray-200 rounded-lg border border-gray-200">
                <ul class="space-y-3 p-2">
                    <li th:if="${task.assignees == null || #lists.isEmpty(task.assignees)}"
                        class="text-gray-500 italic text-center py-2">Nobody assigned</li>

                    <li class="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-200"
                        th:each="assignee : ${task.assignees}">
                        <img alt="Profile Picture"
                             class="w-12 h-12 rounded-full border-2 border-blue-500 object-cover"
                             th:src="${assignee.avatarUrl}"/>

                        <div class="flex flex-col">
                            <span class="text-gray-900 font-medium" th:text="${assignee.name}"></span>
                            <span class="text-sm text-gray-500" th:text="${assignee.role}"></span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-4 border-t pt-6 mt-6">
            <!-- Delete -->
            <form method="post"
                  th:action="@{/tasks/{id}(id=${task.id})}"
                  th:if="${canDelete}">
                <input name="_method" type="hidden" value="delete">
                <button
                        class="flex items-center gap-2 px-5 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-md transition">
                    <img alt="Delete" class="w-5 h-5"
                         src="https://www.pngmart.com/files/17/Waste-Garbage-Can-Vector-PNG-Clipart.png"/>
                    <span class="font-medium">Delete</span>
                </button>
            </form>

            <!-- Modify -->
            <form method="get"
                  th:action="@{/tasks/update/{id}(id=${task.id})}"
                  th:if="${canUpdate}">
                <button
                        class="flex items-center gap-2 px-5 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow-md transition">
                    <img alt="Modify" class="w-5 h-5"
                         src="https://www.pngmart.com/files/23/Pens-PNG-Isolated-File.png"/>
                    <span class="font-medium">Modify</span>
                </button>
            </form>

            <!-- Complete Toggle -->
            <form method="post"
                  th:action="@{/tasks/complete/{id}(id=${task.id})}"
                  th:if="${canUpdate}">
                <label class="flex items-center cursor-pointer gap-3">
                    <span class="font-medium text-gray-700">Mark as completed</span>
                    <div class="relative">
                        <input
                                aria-label="Mark as completed"
                                class="sr-only"
                                id="completed"
                                name="completed"
                                onclick="this.form.submit()"
                                th:checked="${task.status == 'DONE'}"
                                type="checkbox">
                        <div class="block bg-gray-300 w-14 h-8 rounded-full transition-all duration-300"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform duration-300 transform"
                             th:classappend="${task.status == 'DONE'} ? 'translate-x-6 bg-green-500' : ''"></div>
                    </div>
                </label>
            </form>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script th:inline="javascript">
        let task = [[${task}]];
    </script>
    <script>
        const sections = document.querySelectorAll(".sortable");

        sections.forEach(section => {
          new Sortable(section, {
            group: "shared", //allows moving between lists
            animation: 150,
            onAdd: async function (evt) {
              let taskId = evt.item.dataset.id;
              let newSection = evt.to.id;

              //Send PUT request
              await fetch(`/tasks/${taskId}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ newStatus: newSection })
              });
              window.location.reload();
            }
          });
        });
    </script>
</body>
</html>