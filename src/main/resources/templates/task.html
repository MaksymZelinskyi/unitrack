<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Uni-Track</title>
    <link rel="stylesheet" href="/styles/main.css"/>
</head>
<body>
<div th:insert="fragments :: header"></div>

<div class="layout flex-col">

    <div class="flex-row">
        <!-- Task Card -->
        <div class="task-card">

            <!-- Comments Counter -->
            <div class="counter">
                <div class="task-comment-link">
                    <h6 th:text="${comments.size()}" class="label"></h6>
                    <p th:text="${'comment' + (comments.size() == 1 ? '' : 's')}" class="label"></p>
                </div>
                <a href="#comments" class="goto">Go to comments ‚Üí</a>
            </div>

        <!-- Title -->
        <h1 class="task-title-heading" th:text="${task.title}"></h1>

        <!-- Description -->
        <div class="desc">
            <span class="label">Description:</span>
            <p th:text="${task.description}"></p>
        </div>

        <!-- Deadline -->
        <div>
            <span class="date-label">Deadline:</span>
            <span class="date"
                  th:text="${#temporals.format(task.deadline, 'dd MMM yyyy HH:mm')}"></span>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <label class="section-title">Assignees</label>
        <ul class="collab-list">

            <li th:if="${task.assignees == null || #lists.isEmpty(task.assignees)}"
                class="desc">Nobody assigned</li>

            <li th:each="assignee : ${task.assignees}">
                <img alt="Profile Picture" class="avatar" th:src="${assignee.avatarUrl}"/>
                <div>
                    <span class="desc" th:text="${assignee.name}"></span>
                    <span class="desc" th:text="${assignee.role}"></span>
                </div>
            </li>
        </ul>
    </aside>

    <!-- Buttons -->
    <div class="action-buttons">

        <form method="post" th:action="@{/tasks/{id}(id=${task.id})}" th:if="${canDelete}">
            <input name="_method" type="hidden" value="delete">
            <button class="remove-btn">
                <img alt="Delete" src="/assets/delete.png"/>
                <span>Delete</span>
            </button>
        </form>

        <form method="get" th:action="@{/tasks/update/{id}(id=${task.id})}" th:if="${canUpdate}">
            <button class="task-edit-btn">
                <img alt="Modify" src="/assets/pencil.png"/>
                <span>Modify</span>
            </button>
        </form>

        <form method="post" th:action="@{/tasks/complete/{id}(id=${task.id})}" th:if="${canUpdate}">
            <label class="toggle-label">
                <span>Mark as completed</span>
                <div class="toggle-wrapper">
                    <input
                            class="toggle-input"
                            id="completed"
                            name="completed"
                            onclick="this.form.submit()"
                            th:checked="${task.status == 'DONE'}"
                            type="checkbox">
                    <div class="toggle-bg"></div>
                    <div class="toggle-ball"
                         th:classappend="${task.status == 'DONE'} ? 'completed' : ''"></div>
                </div>
            </label>
        </form>
    </div>
    </div>

<!-- Comments Section -->
<div class="container" style="width: 90%;">
    <div class="comments-inner">

        <!-- Add Comment -->
        <form th:action="@{/tasks/comments?taskId={taskId}(taskId=${task.id})}"
              method="post"
              th:object="${commentForm}"
              class="comment-form">

            <div>
                <label class="label">Add a Comment</label>
                <input th:field="*{text}" type="text" placeholder="Write something..." maxlength="255" required class="input"/>
            </div>

            <button type="submit" class="submit-btn">Post</button>
        </form>

        <!-- Comment list -->
        <ul id="comments" class="comment-list">

            <li th:if="${comments == null || #lists.isEmpty(comments)}" class="desc">
                No comments yet ‚Äî be the first!
            </li>

            <li th:each="comment : ${comments}">
                <div class="comment-card">

                    <div class="comment-header">
                        <a th:href="@{/collaborators/{id}(id=${comment.author.id})}">
                            <img alt="Profile Picture"
                                 class="avatar"
                                 th:src="${comment.author.avatarUrl}"/>
                            <div>
                                <h3 class="collab-name" th:text="${comment.author.name}"></h3>
                                <p class="italic"
                                   th:text="${#temporals.format(comment.createdAt, 'dd MMM yyyy HH:mm')}"></p>
                            </div>
                        </a>

                        <a th:if="${comment.replyTo != null}"
                           th:href="'#comment'+${comment.replyTo}"
                           class="reply-ref"
                           th:text="'Replied to ' + ${comment.replyToAuthor}"></a>

                        <button type="button" class="edit-btn"
                                th:if="${comment.author.id == currentUser.id}">
                            ‚úèÔ∏è Edit
                        </button>
                    </div>

                    <p class="comment-text" th:text="${comment.text}"></p>

                    <!-- Edit Form -->
                    <form method="post"
                          th:if="${comment.author.id == currentUser.id}"
                          th:action="@{/tasks/comments/{id}(id=${comment.id})}"
                          class="comment-edit-form hidden">
                        <input type="hidden" name="_method" value="put">
                        <textarea name="text" class="input" th:text="${comment.text}"></textarea>
                        <div>
                            <button type="submit" class="submit-btn">Save</button>
                            <button type="button" class="cancel-btn">Cancel</button>
                        </div>
                    </form>

                    <!-- Delete -->
                    <form method="post"
                          th:action="@{/tasks/comments/{id}(id=${comment.id})}"
                          th:if="${comment.author.id == currentUser.id || currentUser.status == 'Admin'}">
                        <input name="_method" type="hidden" value="delete">
                        <button type="submit" class="delete-btn">
                            <img alt="Delete" src="/assets/delete.png"/>
                            <span>Delete</span>
                        </button>
                    </form>

                    <!-- Reply -->
                    <button type="button" class="reply-btn">üí¨ Reply</button>

                </div>

                <!-- Reply form -->
                <form method="post"
                      class="comment-reply-form hidden"
                      th:action="@{/tasks/comments?taskId={taskId}(taskId=${task.id})}">
                    <input type="hidden" name="replyTo" th:value="${comment.id}"/>
                    <input type="text" name="text" class="input"/>
                    <div>
                        <button type="submit" class="submit-btn">Save</button>
                        <button type="button" class="cancel-btn">Cancel</button>
                    </div>
                </form>
            </li>
        </ul>
    </div>
</div>
</div>

<script src="/js/sortable.min.js"></script>
<script src="/js/comments.js"></script>
</body>
</html>
